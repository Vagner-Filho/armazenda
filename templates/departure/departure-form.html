{{ block "departure-form" . }}
<dialog id="departure-form-dialog" class="rounded-md w-full max-w-3xl bg-stone-100">
    <div class="p-4 relative">
        {{ template "close-dialog-btn" "dialog#departure-form-dialog" }}
        <h1 class="text-center font-medium text-xl">
            Nova Saída
        </h1>
        <form class="flex flex-col gap-4" {{ if .Departure.Id }} hx-put="/departure/{{ .Departure.Id }}"
            hx-target="#departure-{{ .Departure.Id }}" hx-swap="outerHTML" {{ else }} hx-post="/departure"
            hx-target="#departure-table-body" hx-swap="beforeend" {{ end }} hx-indicator="#btns-container">
            <fieldset class="flex flex-col gap-2 p-2 bg-white rounded-lg shadow">
                <legend class="text-lg uppercase rounded-t-lg bg-white px-2 font-light">
                    Identificação
                </legend>
                {{ template "crop-selector" .Crops }}
                {{ template "buyer-selector" .Buyers }}
                <div class="flex flex-col-reverse">
                    <input type="number" name="weight" id="weight" class="peer" value="{{ .Departure.Weight }}" required>
                    <label for="weight" class="label-peer">
                        Peso
                    </label>
                </div>
            </fieldset>
            <fieldset class="flex flex-col gap-2 p-2 bg-white rounded-lg shadow">
                <legend class="text-lg uppercase rounded-t-lg bg-white px-2 font-light">
                    Saída
                </legend>
                {{ template "vehicle-selector" .Vehicles }}
                <div class="flex flex-col-reverse">
                    <input type="datetime-local" name="departureDate" id="departure-input" class="peer" value="{{ .Departure.DepartureDate }}" required>
                    <label for="departure-input" class="label-peer">
                        Data de Saída
                    </label>
                </div>
            </fieldset>
            <div class="flex items-center justify-around mt-2 w-52 mx-auto" id="btns-container">
                <button class="cancel-btn" type="button" onclick="closeDepartureForm()">Cancelar</button>
                <button class="add-btn" type="submit">
                    {{ if .Departure.Id }} Editar {{ else }} Adicionar {{ end }}
                </button>
                <img class="htmx-indicator" src="/public/assets/static/spinner.svg" alt="...">
            </div>
        </form>
    </div>

    <script type="module">
        import { formatDateToInput } from "/public/assets/js/date.js"
        const dateVal = formatDateToInput({{ .Departure.DepartureDate }})
        const dialogEl = document.querySelector("#departure-form-dialog")
        if (dialogEl) {
            dialogEl.showModal()

            const departureDateEl = dialogEl.querySelector("input#departure-input")
            if (!!departureDateEl) {
                departureDateEl.setAttribute("value", dateVal)
            }

            function closeDepartureForm() {
                dialogEl.close()
                dialogEl.remove()
            }

            dialogEl.addEventListener('close', closeDepartureForm)
            window.closeDepartureForm = closeDepartureForm
        }
    </script>
    <style>
        .htmx-indicator {
            display: none;
        }

        .htmx-request button {
            display: none;
        }

        .htmx-request .htmx-indicator {
            display: block
        }
    </style>
</dialog>
{{ end }}
