{{ block "entry-form" . }}
<dialog id="addEntryDialog" class="rounded-md w-4/5">
    <div class="p-4 relative">
        {{ template "close-dialog-btn" "dialog#addEntryDialog" }}
        <h1 class="text-center font-medium text-xl">
            Nova Entrada
        </h1>
        <form class="flex flex-col" {{ if .Entry.Manifest }} hx-put="/entry/{{ .Entry.Manifest }}"
            hx-target="#entry-{{ .Entry.Manifest }}" hx-swap="outerHTML" {{ else }} hx-post="/entry"
            hx-target="#entries-table-body" hx-swap="beforeend" {{ end }} hx-indicator="#btns-container">
            <div class="flex flex-col-reverse">
                {{ template "grain-selector" }}
                <label for="grain-selector" class="label-peer">
                    Grão
                </label>
            </div>
            <div class="flex flex-col-reverse">
                <input type="text" name="harvest" id="harvest" class="peer" value="{{ .Entry.Harvest }}" required>
                <label for="harvest" class="label-peer">
                    Safra
                </label>
            </div>
            {{ template "field-selector" .Fields }}
            {{ template "vehicle-selector" .Vehicles }}
            <div class="flex flex-col-reverse">
                <input type="number" name="grossWeight" id="grossWeight" class="peer" value="{{ .Entry.GrossWeight }}" required>
                <label for="grossWeight" class="label-peer">
                    Peso Bruto
                </label>
            </div>
            <div class="flex flex-col-reverse">
                <input type="number" name="tare" id="tare" class="peer" value="{{ .Entry.Tare }}" required>
                <label for="tare" class="label-peer">
                    Tara
                </label>
            </div>
            <div class="flex flex-col-reverse">
                <input type="number" name="netWeight" id="netWeight" class="peer" value="{{ .Entry.NetWeight }}" disabled>
                <label for="netWeight" class="label-peer">
                    Peso Líquido
                </label>
            </div>
            <div class="flex flex-col-reverse">
                <input type="text" name="humidity" id="humidity" class="peer" value="{{ .Entry.Humidity }}" required>
                <label for="humidity" class="label-peer">
                    Umidade
                </label>
            </div>
            <div class="flex flex-col-reverse">
                <input type="date" name="arrivalDate" id="arrivalDate" class="peer" value="{{ .Entry.ArrivalDate }}" required>
                <label for="arrivalDate" class="label-peer">
                    Data de Recebimento
                </label>
            </div>
            <div class="flex items-center justify-around mt-2 w-52 mx-auto" id="btns-container">
                <button class="cancel-btn" type="button" onclick="closeEntryFormDialog()">Cancelar</button>
                <button class="add-btn" type="submit">
                    {{ if .Entry.Manifest }} Editar {{ else }} Adicionar {{ end }}
                </button>
                <img class="htmx-indicator" src="/public/assets/static/spinner.svg" alt="...">
            </div>
        </form>
    </div>

    <script type="module">
        const dialogEl = document.querySelector("#addEntryDialog")
        if (dialogEl) {
            dialogEl.showModal()
            const arrivalDateEl = dialogEl.querySelector("input#arrivalDate")
            if (!!arrivalDateEl) {
                const longDate = arrivalDateEl.getAttribute("value")
                if (longDate) {
                    arrivalDateEl.setAttribute("value", new Date(Number(longDate)).toLocaleDateString('en-CA'))
                } else {
                    arrivalDateEl.setAttribute("value", new Date().toLocaleDateString('en-CA'))
                }
            }
            function configReqListener(evt) {
                const now = new Date()
                const ad = evt.detail.parameters.get("arrivalDate")
                if (!!ad) {
                    const unixDate = new Date(ad).setHours(24 + now.getHours(), now.getMinutes())
                    evt.detail.parameters.set("arrivalDate", unixDate)
                }
            }

            document.body.addEventListener('htmx:configRequest', configReqListener);

            function closeEntryFormDialog() {
                dialogEl.close()
                dialogEl.remove()
                document.body.removeEventListener('htmx:configRequest', configReqListener)
            }
            dialogEl.addEventListener('close', closeEntryFormDialog)
            window.closeEntryFormDialog = closeEntryFormDialog

            const grossWeightInput = dialogEl.querySelector('input#grossWeight')
            const tareInput = dialogEl.querySelector('input#tare')

            let grossWeightValue = Number(grossWeightInput ? grossWeightInput.value : 0)
            let tareValue = Number(tareInput ? tareInput.value : 0)

            const netWeightInput = dialogEl.querySelector('input#netWeight')
            if (netWeightInput) {
                grossWeightInput.addEventListener('input', (e) => {
                    grossWeightValue = Number(e.target.value) ?? 0

                    netWeightInput.value = grossWeightValue - tareValue
                })
                tareInput.addEventListener('input', (e) => {
                    tareValue = Number(e.target.value) ?? 0

                    netWeightInput.value = grossWeightValue - tareValue
                })
            }
        }
    </script>
    <style>
        .htmx-indicator {
            display: none;
        }

        .htmx-request button {
            display: none;
        }

        .htmx-request .htmx-indicator {
            display: block
        }
    </style>
</dialog>
{{ end }}
